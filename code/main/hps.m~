function [HPS,f0] = hps(x,Fs)
   
% [hps, f0] = HPS(x,Fs) - Harmonic Product Spectrum for f0 estimation
% Returns f0, an estimate for the monophonic input's fundamental
% frequency.
% source: http://stackoverflow.com/questions/19765486/matlab-code-for-
    % harmonic-product-spectrum

% enforce column vector
if (size(x,2) ~= 1)
    x = x';
end

% frame size and fft size, respectively
Nsize = length(x);
Fsize = FFTsize_const();

% frame our input signal
frame = x(1:Nsize);

% window our frame (hanning)
windowed = frame .* hann(length(frame));

% compute fft, throw out symmetry, get magnitude spectrum
FFT = fft(windowed, Fsize);
FFT = FFT(1 : size(FFT,1) / 2);
FFT = abs(FFT);

% obtain integer-downsampled magnitude spectrums
hps1 = downsample(FFT,1);
hps2 = downsample(FFT,2);
hps3 = downsample(FFT,3);
hps4 = downsample(FFT,4);

% Bound f0 search range
lofreq = 50;
hifreq = 1300;

% convert to sample numbers
losamp = round((lofreq/Fs)*Fsize);
hisamp = round((hifreq/Fs)*Fsize);

% obtain harmonic products
HPS = hps1(losamp:hisamp) .* hps2(losamp:hisamp);
HPS = HPS .* hps3(losamp:hisamp) .* hps4(losamp:hisamp);

% get f0
[val, f0samp] = max(HPS);

% Due to inharmonic skewing, HPS' f0 isn't matching with empirical f0.
% Use HPS' f0 to seed peak search, then returned found peak
W = 50;
[val, f0final] = max(FFT(losamp+f0samp-W:losamp+f0samp+W));

f0 = ((losamp + (f0samp - W) + f0final - 1) / Fsize) * Fs;

% figure; plot(FFT);
% hold; plot([zeros(1,losamp + (f0samp - W) + f0final - 1), 1], '+')

end